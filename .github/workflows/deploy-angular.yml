name: Deploy Angular App

on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'client/**'
  #     - '.github/workflows/deploy-angular.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy Angular
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      working-directory: ./client
      run: npm ci

    - name: Create environment file
      working-directory: ./client
      run: |
        echo "Creating environment file..."
        mkdir -p src/assets
        cat > src/assets/env.js << EOF
        (function (window) {
          window["env"] = window["env"] || {};
          window["env"]["apiUrl"] = "${{ secrets.API_URL }}";
          window["env"]["firebaseProjectId"] = "${{ secrets.FIREBASE_PROJECT_ID }}";
          window["env"]["firebaseAppId"] = "${{ secrets.FIREBASE_APP_ID }}";
          window["env"]["firebaseStorageBucket"] = "${{ secrets.FIREBASE_STORAGE_BUCKET }}";
          window["env"]["firebaseApiKey"] = "${{ secrets.FIREBASE_API_KEY }}";
          window["env"]["firebaseAuthDomain"] = "${{ secrets.FIREBASE_AUTH_DOMAIN }}";
          window["env"]["firebaseMessagingSenderId"] = "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}";
        })(this);
        EOF

    - name: Build Angular app
      working-directory: ./client
      run: |
        # Configura variÃ¡veis de ambiente para o build
        export API_URL="${{ secrets.API_URL }}"
        export ENVIRONMENT="production"
        
        # Build da aplicaÃ§Ã£o
        npm run build -- --configuration=$ENVIRONMENT

    - name: Build and Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "client/dist/jullius-app/browser"
        output_location: ""
        skip_app_build: true
        
    - name: Post deployment validation
      run: |
        echo "## ðŸš€ Angular Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Information:" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** production" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information:" >> $GITHUB_STEP_SUMMARY
        echo "- **Node Version:** 18.x" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Configuration:** production" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
