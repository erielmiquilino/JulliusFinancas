name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      resourceGroupName:
        description: 'Nome do Resource Group'
        required: true
        default: 'rg-jullius-prod'

# Adicionar permissÃµes necessÃ¡rias para OIDC
permissions:
  id-token: write
  contents: read

env:
  AZURE_REGION: 'eastus2'

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ github.event.inputs.resourceGroupName }} \
          --location ${{ env.AZURE_REGION }}

    - name: Deploy ARM Template
      run: |
        az deployment group create \
          --resource-group ${{ github.event.inputs.resourceGroupName }} \
          --template-file ./infra/azuredeploy.json \
          --parameters sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD }}" \
          --name jullius-deployment-${{ github.run_number }} \
          --verbose

    - name: Get deployment outputs
      id: get-outputs
      run: |
        outputs=$(az deployment group show \
          --resource-group ${{ github.event.inputs.resourceGroupName }} \
          --name jullius-deployment-${{ github.run_number }} \
          --query properties.outputs -o json)
        
        echo "WEBAPP_URL=$(echo $outputs | jq -r '.webAppUrl.value')" >> $GITHUB_OUTPUT
        echo "STATIC_WEBAPP_URL=$(echo $outputs | jq -r '.staticWebAppUrl.value')" >> $GITHUB_OUTPUT
        echo "SQL_SERVER=$(echo $outputs | jq -r '.sqlServerName.value')" >> $GITHUB_OUTPUT
        echo "SQL_SERVER_FQDN=$(echo $outputs | jq -r '.sqlServerFQDN.value')" >> $GITHUB_OUTPUT
        echo "DATABASE_NAME=$(echo $outputs | jq -r '.databaseName.value')" >> $GITHUB_OUTPUT

    - name: Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Resources Deployed:" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** ${{ github.event.inputs.resourceGroupName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App URL:** ${{ steps.get-outputs.outputs.WEBAPP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App URL:** ${{ steps.get-outputs.outputs.STATIC_WEBAPP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Azure SQL Server:** ${{ steps.get-outputs.outputs.SQL_SERVER }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Database:** ${{ steps.get-outputs.outputs.DATABASE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Deploy the Angular app using the **Deploy Angular App** workflow" >> $GITHUB_STEP_SUMMARY
        echo "2. Deploy the .NET API using the **Deploy .NET API** workflow" >> $GITHUB_STEP_SUMMARY 